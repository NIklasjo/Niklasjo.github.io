<!-- index.html -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fullscreen Presentation med Avgångar</title>
  <style>
    /* Container för slides och widgets */
    .slide-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: black;
      font-family: Arial, sans-serif;
    }

    /* Slide iframe tar hela containern */
    #slides {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      z-index: 0;
    }

    /* SL-widget relativ till slide-container */
    .widget-container {
      position: absolute;
      /* Position i procent av slide-containern */
      bottom: 2%;  /* motsvarar cirka 2px av 100vh */
      right: 21.6%; /* motsvarar cirka 414px av 100vw */
      width: 15.4%; /* cirka 296px av 100vw */
      height: 50.3%; /* cirka 543px av 100vh */
      overflow: hidden;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.75);
      color: white;
      z-index: 2;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }

    /* Väder-widget exempel */
    .weather-widget {
      position: absolute;
      /* Kan justeras i procent eller vw/vh */
      bottom: 36.8%;  /* 400px av 1080px */
      right: 41.7%;   /* 800px av 1920px */
      width: 18.2%;   /* 350px av 1920px */
      height: 32.4%;  /* 350px av 1080px */
      padding: 15px;
      background-color: rgba(0, 0, 0, 0.75);
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      z-index: 5;
    }

    /* Övriga stilar oförändrade */
    .header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .logo-and-title { display: flex; align-items: center; }
    .logo-and-title img { width: 30px; height: auto; margin-right: 10px; }
    .real-time-clock { font-size: 20px; }
    table { width: 100%; font-size: 10px; border-collapse: collapse; }
    th, td { padding: 1px; text-align: left; }
    #departuresTable td:nth-child(3) { text-align: center; }
    th { border-bottom: 1px solid white; padding-bottom: 1px; }
    .sl-container { position: relative; width: 10px; height: 10px; display: flex; justify-content: center; align-items: center; }
    .circle { width: 10px; height: 10px; border: 1px solid white; border-radius: 50%; position: absolute; }
    .letter-t { position: relative; z-index: 1; }
    .line-number { display: inline-flex; justify-content: center; align-items: center; padding: 1px 5px; font-weight: bold; font-size: 10px; border-radius: 1px; }
    .line-number.short { background-color: #007ac2; color: white; }
    .line-number.long { background-color: black; color: white; }
  </style>
</head>
<body>
  <div class="slide-container">
    <!-- Fullskärmspresentation -->
    <iframe id="slides"
      src="https://docs.google.com/presentation/d/e/2PACX-1vRi-AkpEvBey5vRYncDsIq-yLJcEd9ziAHt2KA-9jPCuVlHfbmb1o3HF3_--FcuMWudWyUi9qh-OscW/embed?start=true&loop=true&delayms=25000&rm=minimal"
      allowfullscreen mozallowfullscreen webkitallowfullscreen>
    </iframe>

    <!-- Väder-widget -->
    <div class="weather-widget">
      <a class="weatherwidget-io" href="https://forecast7.com/sv/59d3318d07/stockholm/" data-label_1="SUNDBYBERG" data-label_2="Väder" data-theme="dark" data-basecolor="rgba(0, 0, 0, 0.75)">SUNDBYBERG Väder</a>
    </div>

    <!-- Widgeten för avgångar -->
    <div class="widget-container">
      <div class="header-container">
        <div class="logo-and-title">
          <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA..." alt="SL Logo" />
          <h3 style="margin: 0; font-size: 20px; color: white;">Avgångar</h3>
        </div>
        <div class="real-time-clock" id="real-time-clock"></div>
      </div>
      <table id="departuresTable">
        <thead>
          <tr><th>Avgångar</th><th></th><th>Linje</th><th>Destination</th><th>Avgång</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Service Worker-registrering -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('ServiceWorker registrerad:', reg.scope))
            .catch(err => console.log('ServiceWorker misslyckades:', err));
        });
      }
    </script>

  </div>

  <!-- Script för avgångar och klocka -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      function updateClock() {
        const now = new Date();
        document.getElementById('real-time-clock').textContent = now.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      }
      setInterval(updateClock,1000);
      updateClock();

      const stations = [
        { siteId:9324, name:'Duvbo', allowedDestinations:['Kungsträdgården','Hjulsta'], shortColor:'#007ac2', longColor:'#000000' },
        { siteId:3512, name:'Sundbybergs skola', longColor:'#000000' },
        { siteId:9325, name:'Sundbybergs station', allowedDestinations:['Sickla','Solna station'], color:'#ff7f00' }
      ];

      async function fetchDepartures() {
        const now=new Date(), lowerBound=new Date(now.getTime()+2*60000), futureTime=new Date(now.getTime()+25*60000);
        const allDepartures=[]; const usedKeys={};
        for(const station of stations){
          try{
            const res=await fetch(`https://transport.integration.sl.se/v1/sites/${station.siteId}/departures`);
            if(!res.ok) throw new Error(`Nätverksfel för station ${station.name}`);
            const data=await res.json();
            if(data && data.departures){
              data.departures.forEach(dep=>{
                const line=dep.line.designation, dest=dep.destination;
                const departureTime=new Date(dep.expected);
                if(departureTime<lowerBound||departureTime>futureTime) return;
                if(station.allowedDestinations){
                  const ok=station.allowedDestinations.some(d=>dest.toLowerCase().includes(d.toLowerCase()));
                  if(!ok) return;
                }
                let usedColor='#000000';
                if(station.name==='Duvbo') usedColor=(line.length===2)?station.shortColor:station.longColor;
                else if(station.name==='Sundbybergs skola') usedColor=station.longColor;
                else if(station.name==='Sundbybergs station') usedColor=station.color||'#000000';
                const key=`\${station.siteId}-\${line}-\${dest}-\${dep.expected}`;
                if(!usedKeys[key]){usedKeys[key]=true; allDepartures.push({stop:station.name,line,destination:dest,time:departureTime.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),color:usedColor});}
              });
            }
          } catch(e){ console.error(e); }
        }
        allDepartures.sort((a,b)=>a.time.localeCompare(b.time));
        const tbody=document.querySelector('#departuresTable tbody'); tbody.innerHTML='';
        allDepartures.forEach(dep=>{
          let tSymbol='';
          if(dep.stop==='Duvbo'&&dep.line.length===2) tSymbol=`<div class="sl-container"><div class="circle"></div><div class="letter-t"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect x="20" y="20" width="60" height="20" fill="white"/><rect x="40" y="40" width="20" height="40" fill="white"/></svg></div></div>`;
          const textColor = (dep.stop==='Sundbybergs skola')?'color:white;':'';
          const numClass=(dep.stop==='Duvbo'&&dep.line.length===2)?'short':'long';
          const row=document.createElement('tr');
          row.innerHTML=`<td>\${dep.stop}</td><td>\${tSymbol}</td><td><span class="line-number \${numClass}" style="background-color:\${dep.color};\${textColor}">${dep.line}</span></td><td>\${dep.destination}</td><td>\${dep.time}</td>`;
          tbody.appendChild(row);
        });
      }
      fetchDepartures();
      setInterval(fetchDepartures,20000);
    });
  </script>
</body>
</html>
